# 1.ARM处理器与中断

## 1.1 CPU的内部结构？
CPU的内部结构大致可以分为？
- 控制单元（指令寄存器、指令译码器、操作控制器）
- 运算单元（算数逻辑单元）
- 存储单元（专用寄存器和通用寄存器）
- 时钟

## 1.2 CPU跟内存、虚拟内存、硬盘的关系
- CPU要调用的程序和数据来自硬盘，但是CPU又不能直接读写硬盘上的系统、程序和数据，所以必须先将硬盘的内容存储在内存中，才能被CPU读写
- 内存是一个中转站，对计算机的运行速度有较大的影响
- 当系统需要的内存空间大于实际的物理内存空间时，就需要用到虚拟内存。虚拟内存可以将部分硬盘空间模拟成内存空间，将暂时不运行的程序和不使用的数据存储到硬盘上，需要时再将其存储到内存上。

## 1.3 ARM结构处理器可以分为哪几类？

- 嵌入式微处理器
	- 由通用计算机的CPU演变而来，位数在32位以上，具有较高的性能
- 嵌入式微控制器
	- 又成单片机，一般以某一种微处理器内核为核心，芯片内部集成ROM、RAM、总线、定时/计数器、I/O、A/D等各种必要的功能和外设
- 嵌入式DSP
	- 嵌入式数字信号处理器，硬件结构和指令进行特殊设计，非常擅长高速实现各种数字信号处理运算（如数字滤波、频谱分析）

## 1.4 嵌入式微处理器和DSP有什么区别？

- 微处理器偏控制、DSP偏运算
- 微处理器外围接口丰富，标准化、通用性、功耗控制等做的更好，适用于消费电子、家用电器等控制领域
- DSP对系统结构和指令做了优化，能进行大量数据的快速计算，适用于音视频处理等领域

## 1.5 ARM处理器有哪些工作状态？ARM指令和Thumb指令有什么区别？
- ARM处理器共有ARM、Thumb/Thumb-2、调试三种状态
- ARM指令是32位，较全面；Thumb指令是16位，较精简
- Thumb-2，Thumb-2状态兼容16位和32位指令，具有Thumb-2计数的ARM处理器无需在ARM和Thumb-2状态之间切换
- 调试状态，处理器处于停机调试

## 1.6 RISC精简指令集计算机和CISC复杂指令集计算机的区别
- RISC控制器多采用硬件连线控制方式，以期更快的执行速度；而CISC控制器绝大多数采用微程序控制方式
- RISC只有加载和存储指令可以访问内存，数据处理指令只对寄存器的内容操作，为了加速程序的运算，RISC会设置多组寄存器，并指定特殊用途的寄存器，因此通用寄存器数量较CISC多。CISC架构允许数据处理指令对内存进行操作，因此需要的寄存器数量比较少。
- RISC大多数是在一个时钟周期内完成，且指令长度统一、数量少；而CISC的复杂指令通过CPU内的微码来完成，需要多个时钟周期，而指令长度不一、数量多
- RISC在实现一个功能的时候，需要的指令数目多，编译器设计就更复杂；CISC的指令丰富，它的编译器可以少做很多事
- RISC较CISC更容易实现指令流水线，因为其指令大多在一个时钟周期内完成。

## 1.7 ARM内部传输数据的总线有哪些？
ARM内部传输数据采用ARMA总线，共4个版本
- AMBA1：ASB、APB
- AMBA2：AHB、APB
- AMBA3：AHB、AXI、ATB、APB
- AMBA4：AXI、ATB、ACE、APB

## 1.8 中断是嵌入式系统中重要的组成部分，这导致了很多编译开发商提供了一种扩展：让标准C支持中断。具体表现是，产生了一新的关键字_interrupt，下面的代码就是使用了_interrupt关键字去定义了一个中断服务子程序ISR，这段代码有什么问题
```c
__interrupt double compute_area(double radius){
	double area = PI * radius * radius;
	printf("Area = %f", area);
	return area;
}
```

- 对于单片机来说，ISR不能传递参数
- 对于单片机来说，ISR不能有返回值
- 在许多的处理器/编译器中，浮点运算一般都是不可重入的。此外，ISR应该是短而有效率的，在ISR中做浮点运算是不明智的。
- 与第三点一样，printf()经常有重入和性能问题。
- 重入一般可以理解为一个函数在同时多次调用，例如操作系统在进程调度过程中，或者单片机、处理器等中断的时候会发生重入的现象。以下情况之一的多数是不可重入函数：
	- 使用了静态数据结构
	- 调用了malloc或free
	- 调用了标准I/O函数，标准IO库很多实现都以不可重入的方式使用全局数据结构
	- 进行浮点运算。许多的处理器/编译器中，浮点一般都是不可重入的，浮点运算大多使用协处理器或者软件模拟来实现

## 1.9 简述处理器中断处理的过程

处理器在中断处理的过程中，一般分为以下几个步骤：
- 中断请求
- 中断响应
- 保护现场
- 中断服务
- 恢复现场
- 中断返回

## 1.10 保护现场、恢复现场的过程？

- 保护现场
	- 中断进栈：首先将r0-r7快速中断或r0-r12其他中断push进堆栈中保存，并将堆栈指针保存在对应中断模式的R13（SP）中
	- 保存下一条指令：把即将执行的下一条指令（PC-4）的地址保存到对应中断模式的R14（LR）中；把CPSR的值保存到对应中断模式的SPSR中，以实现对处理器当前状态、中断屏蔽及各标志位的保护
	- 设置CPSR的相应位：设置CPSR的相应位：设置CPSR[4:0]的5位以相应的工作模式；CPSR[5] = 0 切换到ARM状态；设置CPSR[7] = 1禁止IRQ中断；如果进入复位模式或FIQ模式，还要设置CPSR[6] = 1 以禁止FIQ中断
	- 执行中断程序：给程序计数器PC强制赋值，转入中断向量，执行相应的中断服务程序
- 恢复现场
	- 将原来保存在堆栈的R0-R12或R0-R7 POP出栈，赋值给相应的寄存器
	- 将LR的值赋值给PC，将SPSR的值赋值给CPSR中，恢复被中断的程序状态

## 1.11 复位中断与其他中断有什么不同？

- 当中断产生后，复位中断立即中止当前指令的执行，其余情况都是当处理器完成当前指令后，再去响应中断
- 如果是复位中断，系统自动从0x00000000（8个0）开始重新执行程序，无需中断返回

## 1.12 什么是中断向量？什么是中断嵌套？
- 中断向量：中断服务子程序的入口地址
- 中断嵌套：中断系统正在执行一个中断服务程序时，有另一个优先级更高的中断源提出请求，这时会暂停当前正在执行的级别较低的中断源的服务程序，处理级别更高的中断源。处理完毕后再返回到被中断了的中断服务程序。

## 1.13 外部中断请求IRQ和快速中断请求FIQ的异常向量地址分别为？


0x0000 0018,0x0000 001C

## 1.14 中断的优缺点

- 优点：实现CPU和I/O设备的并行，提高CPU的利用率和系统的性能
- 缺点：中断处理过程需要保护现场、恢复现场，整个过程需要一定的时间和空间开销。如果中断的频率太高，会降低系统的性能

## 1.15 中断服务程序能不能有参数和返回值？

- 在单片机裸机程序中，中断服务既不能有参数，也不能有返回值
- 但是在带操作系统的嵌入式系统中，中断服务程序可以有参数，也可以有返回值


# 2. 寄存器与存储器

## 2.1 ARM的31个通用寄存器R0-R15中，程序计数器PC位R15，程序链接寄存器为R14，堆栈指针寄存器SP位R13.


## 2.2 寄存器掉电会丢失数据吗？

寄存器是由触发器构成的，因此掉电会丢失数据

## 2.3 NOR Flash与NAND Flash的区别和联系？


| 特性   | NOR Flash                                                 | NAND Flash                          |
| ---- | --------------------------------------------------------- | ----------------------------------- |
| 单位   | 字节                                                        | 页，一般位512字节                          |
| 容量   | 一般为1-16MB                                                 | 一般为8-128M                           |
| 成本   | 较高                                                        | 较低                                  |
| 性能   | 比NAND Flash稍快                                             | 写入、擦除速度比NOR Flash快很多                |
| 接口   | 带有SRAM接口，有足够的地址引脚来寻址，可以很容易地存取其内部的每一个字节                    | 使用复杂的I/O来串行地存取数据，8个引脚用来传送控制、地址和数据信息 |
| 耐用性  | 最大擦写次数是十万次                                                | 最大擦写次数是一百万次                         |
| 软件支持 | 写入和查出需要MTD，Memory Technology Devices，内存计数驱动程序，运行代码不需要任何软件 | 写入、擦除、运行代码都需要MTD                    |

## 2.4 SRAM、DRAM、SDRAM的区别

- SRAM：静态的随机存储器，加电情况下，不需要刷新，数据不会丢失，CPU的缓存就是SRAM
- DRAM：动态随机存储器，加电情况下，也需要不断刷新，才能保存数据，最为常见的系统内存
- SDRAM：同步动态随机存储器，即数据的读取需要时钟来同步，也用作内存

## 2.5 磁盘和硬盘的关系

磁盘包括软盘和硬磁盘，硬磁盘又叫硬盘

## 2.6 RAM是什么？

- RAM是随机存储器，速度快，可随机读写，但断电则丢失数据，一般用作内存
- RAM的种类有很多，常见的有SRAM、DRAM、SDRAM

## 2.7 ROM是什么？

- ROM是只读存储器，速度慢，不能直接与CPU进行交互，断电后数据部丢失，一般用来保存断电不丢失的程序
- 常见的ROM有，PROM、EPROM、EEPROM

## 2.8 SRAM跟DRAM的区别？


| 特性    | SRAM | DRAM |
| ----- | ---- | ---- |
| 存储原理  | 触发器  | 电容   |
| 是否刷新  | 不需要  | 需要   |
| 运行速度  | 快    | 慢    |
| 存储成本  | 高    | 低    |
| 发热量   | 大    | 小    |
| 送行列地址 | 同时送  | 分两次送 |
| 破坏性读出 | 否    | 是    |
| 集成度   | 低    | 高    |

## 2.9 ARM在不同工作模式时使用的寄存器有所不同，但共同点是？
- R0-R7为公用的通用寄存器
- CPSR为公用的当前程序状态寄存器
- R15为公用的程序计数器PC

## 2.10 CPU要先对cache做什么，才能读取DMA数据？

答案：CPU要先对cache做一个invalidate作废操作，再从内存中读取数据到缓存，保证缓存和内存中数据的一致性，才能读取DMA数据。

解读：
- 为了正确进行DMA操作，DMA，direct memory access，必须进行必要的缓存操作，缓存操作分为invalidate作废和writeback写回
- DMA从外设读取数据供CPU使用，可先进行invalidate作废操作，这样一来，处理器在读取缓存中的数据前，会先从内存中读取数据到缓存，保存缓存和内容中数据的一致性
- DMA初始化设置由处理器提供数据时，可先进行writeback写回操作。这样一来，可以在DMA传输前将缓存的数据写回到内存中，保证内存和缓存中数据的一致性

## 2.11 大小端各自的优点是什么？

- 大端优点：符号位在低地址的第一个字节中，便于快速判断数据的正负和大小
- 小端优点：CPU做数值运算的时候是依次从内存的低位到高位取数据进行运算，这样运行效率更高。强制数据转换不需要调整字节内容，因为1、2、4字节数据的存储方式一样

## 2.12 缓存技术的作用是什么？

- 改善CPU与I/O设备间速度不匹配的矛盾
- 提高CPU和I/O设备之间的并行性，提高系统的吞吐量和设备的利用率
- 减少对CPU中断频率，放宽对中断响应时间的限制

## 2.13 缓存技术的种类

- 单缓冲
- 双缓冲
- 多缓冲
- 缓冲池